<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<style>
.hero-card { border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); padding:16px; }
.crown { font-size:20px; position:absolute; top:-30px; left:50%; transform:translateX(-50%); }
.crown.gold  { color: #FFD700; text-shadow: 0 0 6px rgba(255,215,0,0.6); }
.crown.silver{ color: #C0C0C0; }
.crown.bronze{ color: #CD7F32; }
.win-grid { display:flex; flex-wrap:wrap; gap:12px; margin-top: 3.5rem !important; }
.win-item { width:110px; text-align:center; position:relative; margin-top: 2rem; }
.win-item img { width:100px;height:56px;border-radius:6px; box-shadow:0 4px 10px rgba(0,0,0,0.08); }
.rank-badge { display:inline-block; width:30px; height:30px; border-radius:50%; color:#fff; text-align:center; line-height:30px; margin-right:6px; font-weight:700;}
.rank-badge.gold{ background:linear-gradient(45deg,#FFD700,#FFA500); }
.rank-badge.silver{ background:linear-gradient(45deg,#C0C0C0,#A9A9A9); }
.rank-badge.bronze{ background:linear-gradient(45deg,#CD7F32,#8B4513); }
.hero-label { display:flex; align-items:center; gap:8px; }
.hero-icon-small { width:36px; height:20px; border-radius:4px; }
</style>

<div class="container">
    <h1 class="mb-3">英雄榜单</h1>
    
    <div class="form-inline" style="margin-bottom:10px;">
        <label class="control-label" style="margin-right:5px;">选择赛季：</label>
        <select id="league_select" class="form-control">
            <option value="">全部赛季</option>
            {volist name="leagues" id="league"}
                <option value="{$league.id}" {eq name="$league.id" value="$league_id"}selected{/eq}>{$league.name}</option>
            {/volist}
        </select>
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <div class="hero-card">
                <h5>Pick榜 Top 10</h5>
            <div id="pickChart" style="height:420px;"></div>
        </div>
    </div>

    <div class="col-md-6 mb-3">
        <div class="hero-card">
            <h5>Ban榜 Top 10</h5>
            <div id="banChart" style="height:420px;"></div>
        </div>
        </div>
    </div>

    <!-- 🏆👑🥈🥉 -->
    <div class="hero-card mb-3">
        <h5>轮椅榜 Top 16（仅展示 比赛数 >= {$min_play}）</h5>
        <div class="win-grid mt-2">
            <?php $i = 0; foreach ($winTop as $h): $i++; ?>
            <div class="win-item">
                <?php if($i==1): ?><div class="crown gold">👑</div><?php elseif($i==2): ?><div class="crown silver">🥈</div><?php elseif($i==3): ?>
                <div class="crown bronze">🥉</div>
                <?php endif; ?>
                <img class="hero-link" data-hero-id="{$h['hero_id']}" src="<?php echo $h['img']; ?>" alt="<?php echo $h['name']; ?>">
                <div style="margin-top:6px;font-weight:600;"><?php echo $h['name']; ?></div>
                <div style="color:#28a745;font-weight:700;"><?php echo $h['win_rate']; ?>%</div>
                <div style="font-size:12px;color:#777;"><?php echo $h['win_count']; ?>/<?php echo $h['play_count']; ?></div>
            </div>
            <?php endforeach; ?>
        </div>
    </div>
    
    <div class="hero-card mb-3">
        <h5>陷阱榜 Top 16（仅展示 比赛数 >= {$min_play}）</h5>
        <div class="win-grid mt-2">
            <?php $i = 0; foreach ($lowWinTop as $h): $i++; ?>
            <div class="win-item">
                <?php if($i==1): ?><div class="crown gold">💀</div><?php elseif($i==2): ?><div class="crown silver">🥈</div><?php elseif($i==3): ?>
                <div class="crown bronze">🥉</div>
                <?php endif; ?>
                <img class="hero-link" data-hero-id="{$h['hero_id']}" src="<?php echo $h['img']; ?>" alt="<?php echo $h['name']; ?>">
                <div style="margin-top:6px;font-weight:600;"><?php echo $h['name']; ?></div>
                <div style="color:#28a745;font-weight:700;"><?php echo $h['win_rate']; ?>%</div>
                <div style="font-size:12px;color:#777;"><?php echo $h['win_count']; ?>/<?php echo $h['play_count']; ?></div>
            </div>
            <?php endforeach; ?>
        </div>
    </div>
</div>


<!-- ECharts -->
<script src="/assets/js/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
<script>

// 选择联赛
$('#league_select').change(function(){
    var league_id = $(this).val();
    window.location.href = "/banpick/index?league_id="+league_id+"";
});

// 点击英雄显示最近驾驶员
$(document).on('click', '.hero-link', function(){
    var heroId = $(this).data('hero-id');
    var offset = 0;
    var limit = 10;
    var loading = false;
    var hasMore = true;
    
    var league_id = $('#league_select').val();

    var html = '<div id="matchContainer" style="height:380px; overflow-y:auto; padding:10px;">' +
              '<div style="width:100%;text-align:center;margin-bottom: 5px"><img src="'+this.src+'" style="width:50px;height:28px;"></div>' +
               '<table class="table table-bordered" style="width:100%">' +
               '<tr><th>选手</th><th style="text-align:center;">胜负</th><th style="text-align:center;">结束时间</th></tr>' +
               '</table></div>';
    
    layer.open({
        type: 1,
        title: '最近驾驶员',
        area: ['auto','auto'], // 高度 auto，Layer 不再加滚动条
        maxWidth: 600,                // 最大宽度，桌面端不会太宽
        maxHeight: '80vh',            // 最大高度，防止移动端超出屏幕
        content: html,
        scrollbar: false
    });

    // 弹窗打开后再获取容器
    var $container = $('#matchContainer');
    var $table = $container.find('table');

    function loadMatches(){
        if(loading || !hasMore) return;
        loading = true;

        $.ajax({
            url: '/banpick/recentMatches',
            data: {hero_id: heroId, offset: offset, limit: limit, league_id: league_id},
            success: function(res){
                loading = false;
                if(res.code == 1 && res.data.length){
                    res.data.forEach(function(match){
                        var row = '<tr>';
                        row += '<td style="text-align:center">'+match.player_name+'</td>';
                        row += '<td style="text-align:center">'+match.result+'</td>';
                        row += '<td style="text-align:center">'+match.match_time+'</td>';
                        row += '</tr>';
                        $table.append(row);
                    });
                    offset += res.data.length;

                    if(res.data.length < limit){
                        hasMore = false;
                        $table.append('<tr><td colspan="3" style="text-align:center;color:#999;">没有更多记录</td></tr>');
                    }
                } else {
                    hasMore = false;
                    $table.append('<tr><td colspan="3" style="text-align:center;color:#999;">没有更多记录</td></tr>');
                }
            }
        });
    }

    // 滚动加载
    $container.on('scroll', function(){
        if($container.scrollTop() + $container.innerHeight() >= $container[0].scrollHeight - 10){
            loadMatches();
        }
    });

    // 初次加载
    loadMatches();
});

/* 从后端注入的 JSON（控制器中已赋值） */
var pickNames  = <?php echo $pickNamesJson ?? '[]'; ?>;
var pickCounts = <?php echo $pickCountsJson ?? '[]'; ?>;
var pickImgs   = <?php echo $pickImgsJson ?? '[]'; ?>;

var banNames  = <?php echo $banNamesJson ?? '[]'; ?>;
var banCounts = <?php echo $banCountsJson ?? '[]'; ?>;
var banImgs   = <?php echo $banImgsJson ?? '[]'; ?>;

/* helper: 构建 Y 轴图片 */
function buildYAxisImages(names, imgs) {
    var categories = [];
    var rich = {};
    names.forEach(function(name, idx){
        var key = 'a' + idx;
        categories.push('{'+key+'| }'); // 只显示图片，不显示名字
        rich[key] = {
            width: 50,
            height: 28,
            align: 'left',
            backgroundColor: {
                image: imgs[idx] || ''
            },
            padding: [0,8,0,0]
        };
    });
    return {categories: categories, rich: rich};
}

/* PICK 图 */
(function(){
    var target = document.getElementById('pickChart');
    var chart = echarts.init(target);

    // 先按 pickCounts 从高到低排序
    var data = pickCounts.map((v,i)=>({name: pickNames[i], img: pickImgs[i], value: v}));
    data.sort((a,b)=>b.value - a.value);

    var sortedNames = data.map(d=>d.name);
    var sortedImgs = data.map(d=>d.img);
    var sortedCounts = data.map(d=>d.value);

    var d = buildYAxisImages(sortedNames, sortedImgs);

    var option = {
        tooltip: { 
            trigger: 'axis', 
            axisPointer: { type: 'shadow' },
            formatter: function(params){
                // 显示英雄名字 + 数值
                var idx = params[0].dataIndex;
                return sortedNames[idx] + ': ' + sortedCounts[idx];
            }
        },
        grid: { left: '18%', right: '6%', top: '6%', bottom: '6%' },
        xAxis: { show: false },   // 隐藏 x 轴
        yAxis: {
            type: 'category',
            inverse: true,        // 从上到下高到低
            data: d.categories,
            axisLine: { show: false },
            axisTick: { show: false },
            axisLabel: {
                rich: d.rich,
                formatter: function(v){ return v; },
                interval: 0
            }
        },
        series: [{
            type: 'bar',
            data: sortedCounts,
            label: { 
                show: true, 
                position: 'right',
                formatter: function(params){
                    return params.value; // 在柱子末端显示名字
                }
            },
            itemStyle: { color: '#3b8bff' }
        }]
    };
    chart.setOption(option);
})();

/* BAN 图 */
(function(){
    var target = document.getElementById('banChart');
    var chart = echarts.init(target);

    // 先按 banCounts 从高到低排序
    var data = banCounts.map((v,i)=>({name: banNames[i], img: banImgs[i], value: v}));
    data.sort((a,b)=>b.value - a.value);

    var sortedNames = data.map(d=>d.name);
    var sortedImgs = data.map(d=>d.img);
    var sortedCounts = data.map(d=>d.value);

    var d = buildYAxisImages(sortedNames, sortedImgs);

    var option = {
        tooltip: { 
            trigger: 'axis', 
            axisPointer: { type: 'shadow' },
            formatter: function(params){
                // 显示英雄名字 + 数值
                var idx = params[0].dataIndex;
                return sortedNames[idx] + ': ' + sortedCounts[idx];
            }
        },
        grid: { left: '18%', right: '6%', top: '6%', bottom: '6%' },
        xAxis: { show: false },   // 隐藏 x 轴
        yAxis: {
            type: 'category',
            inverse: true,        // 从上到下高到低
            data: d.categories,
            axisLine: { show: false },
            axisTick: { show: false },
            axisLabel: {
                rich: d.rich,
                formatter: function(v){ return v; },
                interval: 0
            }
        },
        series: [{
            type: 'bar',
            data: sortedCounts,
            label: { 
                show: true, 
                position: 'right',
                formatter: function(params){
                    return params.value;
                }
            },
            itemStyle: { color: '#3b8bff' }
        }]
    };
    chart.setOption(option);
})();
</script>
