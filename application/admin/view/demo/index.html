<div class="panel panel-default panel-intro">
    {:build_heading()}

    <div class="panel-body">
        <div id="myTabContent" class="tab-content">
            <div class="tab-pane fade active in" id="one">
                <div class="widget-body no-padding">
                    <form id="upload-form" class="form-horizontal" method="post" enctype="multipart/form-data">
                        <div class="form-group">
                            <label class="control-label col-xs-12 col-sm-2">上传.dem文件:</label>
                            <div class="col-xs-12 col-sm-8">
                                <input type="file" name="demfile" accept=".dem" required />
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-xs-12 col-sm-8 col-sm-offset-2">
                                <button type="submit" id="upload-btn" class="btn btn-success">上传并解析</button>
                            </div>
                        </div>
                    </form>

                    <!-- loading 遮罩 -->
                    <div id="upload-loading" style="display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.7);z-index:9999;text-align:center;padding-top:200px;font-size:20px;">
                        <i class="fa fa-spinner fa-spin"></i> 上传中...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/assets/js/jquery.min.js"></script>
<script>
$(function(){
    $('#upload-form').on('submit', function(e){
        e.preventDefault();

        var fileInput = $('input[name="demfile"]')[0];
        if(fileInput.files.length === 0){
            alert('请选择文件');
            return;
        }

        var formData = new FormData();
        formData.append('demfile', fileInput.files[0]);

        // 显示 loading，禁用按钮
        $('#upload-loading').show();
        $('#upload-btn').prop('disabled', true);

        $.ajax({
            url: "{:url('demo/upload')}", // 控制器方法完整 URL
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function(res){
                $('#upload-loading').hide();
                $('#upload-btn').prop('disabled', false);

                if(res.code == 1){
                    alert('上传成功');
                } else {
                    alert('上传失败: ' + res.msg);
                }
            },
            error: function(xhr, status, error){
                $('#upload-loading').hide();
                $('#upload-btn').prop('disabled', false);
                alert('上传出错: ' + error);
            }
        });
    });
});
</script>
